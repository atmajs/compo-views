/*!
 * Form Component v0.10.24
 * Part of the Atma.js Project
 * http://atmajs.com/
 *
 * MIT license
 * http://opensource.org/licenses/MIT
 *
 * (c) 2012, 2016 Atma.js and other contributors
 */
"use strict";!function(t,e){function n(t,e){var n=i[t]||i.atma&&i.atma[t];if(null!=n)return n;if("function"==typeof require)return require(e);throw Error(t+" was not loaded")}var i="undefined"!=typeof global?global:window,r=n("mask","maskjs"),o=n("ruta","ruta");e(i,r,r.jmask,r.Compo,r.Compo.config.getDOMLibrary(),o)}(void 0,function(t,e,n,i,r,o){var s;!function(){s=function(n){return e.obj.get(n,"req.url")||t.location.pathname+t.location.search}}();var a,u;!function(){u={NONE:0,LOADING:1,LOADED:2,RENDERING:3,RENDERED:4},a=e["class"].create({viewNode:null,nodes:null,compo:null,route:null,state:u.NONE,path:null,"default":!1,constructor:function(){for(var t=arguments.length,n=Array(t),i=0;t>i;i++)n[i]=arguments[i];for(var r=n.length,o=-1;++o<r;){var s=n[o];null!=s&&(e.obj.extend(this,s),null!=s.view&&null==this.path&&(this.path=s.view))}},getNodes:function(){return null!=this.viewNode?(null!=this.path&&null==this.viewNode.nodes&&(this.viewNode.nodes=e.parse("import from '"+this.path+"'")),this.viewNode):null==this.nodes&&null!=this.path?this.nodes=e.parse("import from '"+this.path+"'"):this.nodes},toJSON:function(){return{route:this.route,state:this.state,path:this.path,viewNode:this.viewNode?e.stringify(this.viewNode):null,nodes:this.nodes?e.stringify(this.nodes):null}},createViewNode:function(t){var e=n(t);if(this.hasView_(e)===!1){var i=this.viewNode||n("View");return void(this.viewNode=n(i).append(t))}this.viewNode=e[0]},hasView_:function(t){if(1!==t.length)return!1;var e=t.tag();return e[0]===e[0].toUpperCase()}}),a.createFromNode=function(t){return new a({viewNode:t,route:t.attr.route,path:t.attr.path,"default":Boolean(t.attr["default"])})},a.createFromObj=function(t){return new a({route:t.route,path:t.path||t.view,"default":Boolean(t["default"])})}}();var c;!function(){c=e["class"].create({views:null,constructor:function(){this.views=[]},add:function(t){this.views.push(t)},each:function(t){for(var e=this.views.length,n=-1;++n<e;)t(this.views[n])},toJSON:function(){return this.views.map(function(t){return t.toJSON()})}}),c.ensure=function(t,n,i){var r=t.viewmap;if(null!=r)return r;var r=new c,o=t.scope.viewmap;if(null==o&&t.xViewmap){var s=e.Utils.Expression.eval;o=s(t.xViewmap,n,i,t)}if(null==o&&e.is.NODE&&(o=c.getFromRoutes(t,i)),e.is.Array(o)){var u=o;u.map(a.createFromObj).forEach(function(t){r.add(new a(r[t.route],t))})}else if(e.is.Object(o)){var l=o;for(var h in l){var f=l[h];null==f.route&&(f.route=h),r.add(a.createFromObj(f))}}return e.jmask(t.nodes).filter("View").map(a.createFromNode).each(function(t){r.add(new a(r[t.route],t))}),t.viewmap=r},c.getFromRoutes=function(t,e){if(null==e.page||null==e.config)return null;var n,i,r=e.page.data,o=e.config.pages,s=[];for(n in o)i=o[n],i.template===r.template&&s.push(i);return s},c.createRoutes=function(t){for(var e=t.viewmap,n=e.views,i=n.length,r=-1;++r<i;){var o=n[r];t.routes.add(o.route,o)}},c.getRouteByPath=function(t,e){var n=t.routes,i=n.get(e);if(i)return i;for(var r=t.viewmap,s=r.views,a=s.length,u=-1;++u<a;){var c=s[u];if(1==c["default"]){var i=n.get(c.route);return i.definition.indexOf("?")>-1&&o.navigate(i.definition,{extend:!0,silent:!0,replace:!0}),i}}return null},c.getRouteByPathOrCurrentOrDefault=function(t,e){var n=t.routes,i=n.get(e),r=null!=i;if(null==i&&(i=t.route),null==i)for(var s=t.viewmap,a=s.views,u=a.length,c=-1;++c<u;){var l=a[c];if(1==l["default"]){i=n.get(l.route);break}}return null==i?null:(r===!1&&i.definition.indexOf("?")>-1&&o.navigate(i.definition,{extend:!0,silent:!0,replace:!0}),i)},c.bindRouter=function(t,e,n){var i=c.ensure(t,e,n);return null==i?void console.error("Viewmap is undefined"):void(t.xNested===!0&&t.isNested()===!0||i.each(function(e){o.add(e.route,function(e){t.navigate(e.current.path)})}))}}();var l;!function(){l=e["class"].create(Object.defineProperties({tickStart:null,tickEnd:null,history:null,vm:null,constructor:function(t){this.history=[],this.routes=[],this.vm=t},show:function(t,e){var n,i=this,r=this.routes.indexOf(t);return-1===r?(t.dfr=n=e(),this.routes.push(t)):n=this.routes[r].dfr,this.history.push({current:t.current,route:t}),this.requestProgressStart(),n.done(function(){return i.requestProgressEnd(t)}).fail(function(){})},clear:function(t){var e=this.routes.indexOf(t);-1!==e&&(t.dfr=null,t.value.compo=null,this.routes.splice(e,1))},requestProgressStart:function(t){this.cancelProgressEnd(),this.tickStart=setTimeout(this.progressStart.bind(this,t))},requestProgressEnd:function(t){this.cancelProgressStart(),this.tickEnd=setTimeout(this.progressEnd.bind(this,t))},cancelProgressStart:function(){clearTimeout(this.tickStart)},cancelProgressEnd:function(){clearTimeout(this.tickEnd)},progressStart:function(){this.cancelProgressEnd(),this.vm.emitIn("viewActivity","start")},progressEnd:function(t){null!=t&&this.current!==t||(this.cancelProgressStart(),this.cancelProgressEnd(),this.vm.emitIn("viewActivity","end"))},back:function(){return this.history.pop(),this.history.pop()}},{current:{get:function(){var t=this.history[this.history.length-1];return t&&t.route},configurable:!0,enumerable:!0}}))}();var h;!function(){function t(e,n){if(null==e)return null;var i=e.components;if(null==i)return null;for(var r=i.length,o=-1;++o<r;){var s=i[o],a=s.compoName||s.tagName;if("imports"===a||"import"===a){var u=t(s,n);if(u)return u}if("Animation"===a&&s.attr.id===n)return s}return null}h=e["class"].create({vm:null,constructor:function(t){this.vm=t},show:function(t){var e=function(e,n,i){return t.apply(this,arguments)};return e.toString=function(){return t.toString()},e}(function(t,e,n){var i=this,r=this.getShow(t),o=this.getHide(e);return r.parallel?(this.hide_(o,e),void this.show_(r,t,n)):void this.hide_(o,e).then(function(){return i.show_(r,t,n)})}),show_:function(t,n,i){var r=this;return e["class"].Deferred.run(function(e){r.vm.showCompo_(n.value.compo,i).then(function(){var i=n.value.compo.$[0];t.start(e,i)})})},hide_:function(t,n){var i=this;return e["class"].Deferred.run(function(e){return null==n.value.compo?void e():void t.start(function(){i.vm.hideCompo_(n.value.compo).then(e)},n.value.compo.$[0])})},getShow:function(t){return this.getAniForRoute(t,"show")},getHide:function(t){return this.getAniForRoute(t,"hide")},getAniForCompo:function(e,n){return t(e,n)},getAniForRoute:function(t,e){var i=this.getAniForCompo(t.value.compo,e);return null==i&&(i=this.getAniForCompo(this.vm,e)),i?i:n}});var n={attr:{},start:function(t){t()}}}();var f=e.Compo({tagName:"div",attr:{style:"position: relative","class":"v-manager"},meta:{attributes:{base:"",viewmap:"",routing:!0,nested:!0},serializeScope:!0},serializeScope:function(){return JSON.stringify(this.scope)},slots:{viewNavigate:function(t,e,n){if(t!==this){var i=this.route;i&&i.value&&i.value.compo;return this.navigate(e,n,{defaultView:!1}),!1}},viewActivation:function(t){if(t!==this){this.route&&this.route.value&&this.route.value.compo;return!1}},viewDeactivation:function(t){this.route&&this.route.value&&this.route.value.compo;return!1},back:function(t){var e=this.activityTracker.back();this.navigate(e.current.path)}},scope:{notificationMsg:"",notificationType:"",viewmap:null},viewmap:null,routes:null,route:null,next:null,activity:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];this.emitIn.apply(this,["views:activity",t].concat(n))},constructor:function(){this.routes=new o.Collection},onRenderStart:function(t,e){var r=this;c.ensure(this,t,e),c.createRoutes(this);var o=s(e),a=c.getRouteByPath(this,o);if(e.params=a&&a.current&&a.current.params,this.attr.path=o,this.route=a,this.nodes=n().add(this.getCompo_("Notification")).add(this.getCompo_("Progress")).add(this.getCompo_("Animation"),!1),null!=a){var u=a.value;if(null==u.path)return void this.nodes.add(u.getNodes()||n());var l=i.pause(this,e);this.loadView(a,t).done(function(t){r.nodes.add(u.getNodes()||n()),l()}).fail(function(){return l()})}},onRenderStartClient:function(t,e){c.ensure(this,t,e),c.createRoutes(this)},onRenderEndServer:function(){this.scope.viewmap=this.viewmap.toJSON()},onRenderEnd:function(t,e,n){var r=this;if(this.activityTracker=new l(this),this.viewChanger=new h(this),this.ctx=n,this.xRouting&&c.bindRouter(this,e,n),null==this.route&&null!=this.attr.path&&(this.route=c.getRouteByPath(this,this.attr.path)),null!=this.route){var o=this.route.value,s=this.find("View");null!=s&&s.emitIn("viewActivation"),o.compo=s,this.activityTracker.show(this.route,function(){return i.await(r)})}},getCtx:function(t){var n=e.obj.extend(null,this.ctx);return n.params=t.current.params,n},isNested:function(){var t=i.closest(this.parent,"ViewManager");return null!=t},navigate:function(t,n,i){var r=this,o=c.getRouteByPathOrCurrentOrDefault(this,t),s=new e["class"].Deferred;if(null==o)return s.reject("View not found: "+t);var a=null==o.value.compo;return this.activityTracker.show(o,function(){return r.loadView(o,n).then(function(){return r.renderView(o,n)})}).done(function(){a===!1&&o.value.compo.emitIn("viewNavigate",t),r.performShow(o,a)})},hideCompo_:function(t){return null!=t?(t.emitIn("viewDeactivation",this),t.hide_()):void 0},showCompo_:function(t,e){var n=this;return t.show_().then(function(){return t.emitIn("viewActivation",n)})},emit:function(t){for(var e,n=arguments.length,r=Array(n>1?n-1:0),o=1;n>o;o++)r[o-1]=arguments[o];(e=i.pipe("views")).emit.apply(e,[t,this].concat(r))},activate:function(t){compo.emitIn("viewActivation",t.current.params)},loadView:function(t,n){return e["class"].Deferred.run(function(n,i){var r=t.value;if(null!=r.viewNode)return void n(t);var o=r.path;e.Module.createModule(new e.Module.Endpoint(o,"mask")).loadModule().fail(i).done(function(e){var i=e.exports.__nodes__;r.createViewNode(i),n(t)})})},renderView:function(t,n){var r=this;return e["class"].Deferred.run(function(o,s,a){if(t.value.compo)return void o(t);var u=r.getCtx(t);e.renderAsync(t.value.getNodes(),n||r.model,u,null,r).done(function(e,n){var r=n.components[n.components.length-1],s=i.prototype.find.call(r,"View");t.value.compo=s,o(t)})})},performShow:function(t,e){var n=this.route;n!==t&&(this.route=t,this.viewChanger.show(t,n,e),null!=n&&null!=n.value.compo&&n.value.compo.xRecycle===!0&&this.activityTracker.clear(n))},notify:function(t,e){0===arguments.length&&(t=e=""),this.scope.notificationType=t,this.scope.notificationMsg=e,this.emitIn("formNotification",{type:t,message:e})},getCompo_:function(t){var e=void 0===arguments[1]?!0:arguments[1],i=n(this).children(t);return e===!1?i:0===i.length?n(t):i},throw_:function(t){this.nodes=e.parse("\n			div style='background: red; color: white; padding: 15px; font-weight: bold' {\n				\""+t.message+'"\n			}\n		')},errored_:function(t){this.activity("end"),this.activity("error",t),this.notify("danger",t.message||String(t))}}),v="\n	// source Notification.mask\n	let Notification as (div) {\n		\n		slot formNotification () {\n			var form = this.closest('a:form');\n			if (!form.scope.notificationMsg) {\n				return;\n			}\n			var el = this.$.get(0);\n			if (el) {\n				el.scrollIntoView(true);\n			}\n		}\n		\n		@if (template) {\n			@template;\n		}\n		@else {\n			+if (notificationMsg) {\n				.alert.alert-~[bind: $scope.notificationType] > '~[bind: $scope.notificationMsg ]'\n			}\n		}\n	}\n	// end:source Notification.mask\n	// source Progress.mask\n	let Progress {\n		var value = -1;\n		var progress = false;\n	\n		slot viewActivity (sender, type, percent) {\n			if (type === 'start') {\n				this.scope.progress = true;\n			}\n			if (type === 'end') {\n				this.scope.progress = false;\n			}\n			if (type === 'progress' && typeof percent === 'number') {\n				this.scope.value = percent;\n			}\n		}\n	\n		.-a-views-progress style='display: ~[bind: $scope.progress ? \"block\" : \"none\" ]'{\n	\n			progress value='~[bind: $scope.value == -1 ? null : $scope.value]' max=100;\n	\n			style scoped {\n				progress {\n					display: block;\n					margin: auto;\n					width: 98%;\n					height: 3px;\n				}\n			}\n		}\n	}\n	// end:source Progress.mask\n";e.define(f,v);var d;!function(){var t=1,n=2,r=3,o=5;d=i({meta:{attributes:{"default":!1,detach:!0,recycle:!1,replace:{description:"This node should be replaced with the loaded template","default":!1}}},slots:{viewDeactivation:function(){return this.state===o?!1:void(this.state=o)}},tagName:"div",attr:{"class":"v-view",style:"position:relative"},onRenderStart:function(){},state:t,hide_:function(){var t=this;return this.hide().then(function(){if(t.xRecycle===!0)return void t.remove();if(t.xDetach===!0){t.state=n;var e=t.$.detach||t.$.remove;e.call(t.$)}})},show_:function(){return this.state<=r&&this.parent.$.append(this.$),this.state===t&&(this.emitIn("domInsert"),this.state=r),this.show()},hide:function(){return this.$.hide(),(new e["class"].Deferred).resolve()},show:function(){return this.$.show(),(new e["class"].Deferred).resolve()}}),e.define(f,"View",d)}(),e.registerHandler("ViewManager",f)});
//# sourceMappingURL=views.min.js.map