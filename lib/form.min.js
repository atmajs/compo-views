/*!
 * Form Component v0.10.17
 * Part of the Atma.js Project
 * http://atmajs.com/
 *
 * MIT license
 * http://opensource.org/licenses/MIT
 *
 * (c) 2012, 2015 Atma.js and other contributors
 */
"use strict";!function(t,e){var n="undefined"!=typeof global?global:window,r=n.mask||n.atma&&n.atma.mask;if(null==r){if("function"!=typeof require)throw Error("MaskJS was not loaded");mask=require("maskjs")}e(n,r,r.Compo.config.getDOMLibrary())}(void 0,function(t,e,n){var r,o,i;!function(){o=function(t){return Object.prototype.toString.call(t).replace("[object ","").replace("]","")},function(){i=function(t){if(null==t||"object"!=typeof t)return t;var e,n=o(t);if("Date"===n)return new Date(t);if("Array"===n){e=[];for(var r=-1,a=t.length;++r<a;)e[r]=i(t[r]);return e}if("Object"===n){e={};for(var s in t)e[s]=i(t[s]);return e}return t}}(),r=function(t,e){var n=void 0===arguments[2]?{}:arguments[2];if(null==t)return n;var i=o(t);if("Array"===i)return t.forEach(function(t,o){r(t,e+"["+o+"]",n)}),n;if("Object"===i){e&&(e+=".");var a,s,l;for(a in t)if(s=t[a],l=e+a,null!=s){var i=o(s);switch(i){case"Object":case"Array":r(s,l,n);continue;case"String":case"Number":case"Boolean":case"Blob":case"File":l in n&&console.warn("ToFormData: Overwrite property",l),n[l]=s;continue;case"Date":n[l]=s.toISOString();continue;default:console.error("Possible type violation",i),n[l]=s;continue}}return n}switch(i){case"Date":t=t.toISOString();break;case"String":case"Number":case"Boolean":case"Blob":case"File":break;default:console.error("Possible type violation",i)}return e in n&&console.warn("ToFormData: Overwrite property",e),n[e]=t,n}}();var a;!function(){a=function(t,e){var n=void 0===arguments[2]?"":arguments[2],o=r(e,n);for(var i in o){var a=null,s=o[i];"object"==typeof s&&s.fileName&&(a=s.fileName),null==a?t.append(i,s):t.append(i,s,a)}}}();var s;!function(){s=function(t,n){e.TreeWalker.walk(t,function(e){return e!==t?n(e):void 0})}}();var l,u,c;!function(){l=function(n,r){return n.replace(t,function(t,n){var o=e.obj.get(r,n);return o?"/"+o:""})},c=function(e){var n=t.exec(e);return null==n?null:n[1]},u=function(e){return t.test(e)};var t=/\/:([\w\.]+)/}();var d,h,f,p;!function(){function t(t,e){t.toBlob(e,"image/jpeg",.9)}function e(t,e){n(URL.createObjectURL(t),e)}function n(t,e){var n=new Image;n.onload=function(){e(r(n))},n.src=t}function r(t,e,n,r,o){null==e&&(e=0,n=0,r=t.width,o=t.height);var i=document.createElement("canvas");i.width=r,i.height=o;var a=i.getContext("2d");return a.fillStyle="#ffffff",a.fillRect(0,0,r,o),a.drawImage(t,e,n,r,o,0,0,r,o),i}function o(t,e,n){var r=document.createElement("canvas");r.width=e,r.height=n;var o=t.width,i=t.height,a=o,s=i,l=0,u=0;if(Math.abs(e/n-o/i)>.05){e>n&&(s=o*n/e,s>i&&(s=i,a=i*e/n)),n>e&&(a=i*e/n,a>o&&(a=o,s=o*n/e))}return l=(o-a)/2,u=(i-s)/2,r.getContext("2d").drawImage(t,l,u,a,s,0,0,e,n),r}d=function(t,e){var n=new window.FileReader;n.readAsDataURL(t),n.onloadend=function(){return e(n.result)}},h=function(t,e){var n=new Image;n.onload=function(){e(r(n))},n.src=URL.createObjectURL(t)},p=function(n,r,i,a){e(n,function(e){e=o(e,r,i),t(e,a)})},f=function(e,n,i,a){var s=r(e);s=o(s,n,i),t(s,a)}}();var m;!function(){m=e["class"].create(e["class"].EventEmitter,e["class"].Deferred,{constructor:function(t,e){this.url=t,this.method=e,this.xhr_=null,this.loadPercent=0,this.uploadPercent=0,this.headers={}},write:function(t){return this.data=t,"Object"===o(t)&&(this.data=JSON.stringify(t)),this},writeHeaders:function(t){return e.obj.extend(this.headers,t),this},setEndpoint:function(t,e){return this.url=t,this.method=e,this},isBusy:function(){return null!=this.xhr_},loading_:function(t){this.emit("progress","load",this.loadPercent=t)},uploading_:function(t){this.emit("progress","upload",this.uploadPercent=t)},readResponse_:function(t){var e=this.xhr_,n=e.responseText||"",r=e.getResponseHeader("content-type");if(null==r)return t(Error("Content-Type not set"));if(/json/i.test(r))try{n=JSON.parse(n)}catch(o){return t(Error("Json response malformed: "+String(o)))}return 200===e.status?t(null,n):t(this.toError_(e,n))},toError_:function(t,e){var n=t.status,r=t.responseText||t.statusText;return null!=e&&"object"==typeof e&&(n=e.status||n,r=e.message||e.error||r),new b(r,n)},complete_:function(t,e){return this.loading_(100),this.xhr_=null,t?(this.emit("error",t),void this.reject(t)):(this.emit("complete",e),void this.resolve(e))},send:function(){var t=this;if(this.isBusy())throw Error("Request is not reusable");var e=this.xhr_=new XMLHttpRequest;e.onload=function(){t.readResponse_(function(e,n){return t.complete_(e,n)})},e.upload&&(e.upload.onprogress=function(e){if(e.lengthComputable){var n=(e.loaded,e.total,e.loaded/e.total*100|0);return void t.uploading_(n)}return t.uploadPercent<90?void t.uploading_(t.uploadPercent+10):void t.uploading_(100)}),e.open(this.method,this.url);for(var n in this.headers)e.setRequestHeader(n,this.headers[n]);return this.emit("start"),e.send(this.data),this}})}();var v,y=(e["class"].create({run:function(t){for(var e=this,n=arguments.length,r=Array(n>1?n-1:0),o=1;n>o;o++)r[o-1]=arguments[o];this.error=null;var i,a=this[t];return r.unshift(this),a.forEach(function(t){e.error||(i=e.perform(t,r))}),i},perform_:function(t,e){var n="string"==typeof t?this[t]:t;try{return n.apply(null,e)}catch(r){this.error=r,this.throw_(r)}},throw_:function(t){throw t}}),e["class"].create(Object.defineProperties({body:null,headers:null,method:"POST",endpoint:window.location.href,contentType:"application/json",constructor:function(t){var e=void 0===arguments[1]?{}:arguments[1];this.body=t,this.headers=e.headers,e.endpoint&&(this.endpoint=e.endpoint),e.method&&(this.method=e.method),e.contentType&&(this.contentType=e.contentType)},serializeHeaders:function(){var t={};return this.isFormData_()===!1&&(t["Content-Type"]=this.contentType),e.obj.extend(t,this.headers)},serialize:function(){return null==this.body?null:this.isFormData_()?this.formData:JSON.stringify(this.body)},isFormData_:function(){return/form-data/i.test(this.contentType)}},{formData:{get:function(){var e=new t.FormData;return a(e,this.body),e},configurable:!0,enumerable:!0}}))),g=e["class"].createError("ValidationError",{constructor:function(t){null!=t&&"object"==typeof t&&(this.message=t.message||t.error||String(t))},message:""}),b=e["class"].createError("HttpError",{status:500,message:"",constructor:function(t,e){this.status=e,this.message=t}});!function(){v={getJson:function(t){return new m(t,"GET").send()},getGetterEndpoint:function(t,e){var n=t.xGet,r="get"===n||n===!0?t.xAction:n;return l(r,e)},send:function(t){var e=t.endpoint,n=t.method,r=(t.serialize(),new m(e,n));return r.write(t.serialize()).writeHeaders(t.serializeHeaders()).send()}}}();var x;!function(){x={process:function(t){var e;return s(t,function(t){var n=t.compoName;if((":dualbind"===n||"dualbind"===n)&&(e=t.provider.validate()))return{"break":!0};var r=t.validateUi||t.validate;return null!=r&&(e=r.call(t))?{"break":!0}:void 0}),e}}}();var k,w=function(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0})};!function(){function t(t){var r=t.model.entity,o=n(r,!0),i=e.obj.extend({},o);return s(t,function(t){var r=n(t,!1);if(r){var o=t.attr&&t.attr.property;return o&&(r=w({},o,r)),e.obj.extend(i,r),{deep:!1}}}),i}function n(t,e){if(null==t)return null;var n=t.toJson||t.toJSON;return null==n?e?t:null:n.call(t)}k={createMessage:function(t){var e=void 0===arguments[1]?{}:arguments[1],n=this.getJson(t),r=e.contentType||t.xContentType,o=e.action||t.xAction,i=e.method||t.xMethod,a=c(o);return a&&(o=l(o,n),null!=n[a]&&(i=e.methodEdit||t.xMethodEdit)),new y(n,{contentType:r,endpoint:o,method:i})},createDeleteMessage:function(t,e){var n=t.xAction,r=t.xContentType,o="DELETE",i=c(n);if(i){if(null==e[i])throw Error("`DELETE` method expects key in the model");n=l(n,e)}return new y(null,{contentType:r,endpoint:n,method:o})},getJson:function(t){var e=function(e){return t.apply(this,arguments)};return e.toString=function(){return t.toString()},e}(function(e){var n=i(t(e)),r=e.transformData(n);return null!=r&&(n=r),n})}}();var E=e.Compo({tagName:"form",builder:null,transport:null,model:null,entity:null,meta:{attributes:{"form-type":"","content-type":"application/json",offset:0,method:"POST","method-edit":"PUT","detached-model":!1,action:window.location.href,get:"",redirect:"","in-memory":!1},template:"merge"},attr:{style:"position: relative;"},slots:{submit:"submit","delete":function(){this.removeEntity()}},events:{submit:function(t){t.preventDefault()}},scope:{notificationMsg:"",notificationType:""},submit:function(t){t.preventDefault(),this.uploadEntity()},validate:function(){return x.process(this)},activity:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;e>r;r++)n[r-1]=arguments[r];switch(this.emitIn.apply(this,["formActivity",t].concat(n)),t){case"start":case"end":this.signalState("submit","end"===t);break;case"error":this.emitOut("error",n[0])}},onRenderStart:function(t,n){var r=t||{};this.model={entity:r},this.ensureReflect_(),this.ensureCompo_("Notification"),this.ensureCompo_("Progress"),this.formLayout_();var o=e.jmask("+with (entity) > div");return o.children().append(this.nodes),this.nodes=o,this.xGet?(this.model.entity=null,this.loadEntity(v.getGetterEndpoint(this,r))):void 0},setEntity:function(t){if(this.entity=t,this.notify(),this.xDetachedModel===!1)return void(this.model.entity=t);var n=this.model.entity||{};e.obj.extend(n,t),null==this.model.entity&&(this.model.entity=n)},getEntity:function(){return this.entity||this.model.entity},removeEntity:function(t){var e=this;this.activity("start");var n=t||this.getEntity(),r=k.createDeleteMessage(this,n);return v.send(r).fail(function(t){return e.errored_(t)}).done(function(t){e.activity("end","delete"),e.emitOut("complete",t),e.emitOut("formDelete",e.getEntity(),t)})},uploadEntity:function(){var t=this;if(!this.xhr||!this.xhr.isBusy()){var e=this.validate();if(e)return void this.errored_(new g(e));if(this.xInMemory){var n=k.getJson(this);return void this.emitOut("complete",n)}var r=k.createMessage(this),e=this.validateData(r.body);if(e)return void this.errored_(new g(e));this.activity("start"),this.xhr=v.send(r).fail(function(e){return t.errored_(e)}).done(function(e){if(t.notify("success","OK"),t.xRedirect)return t.notify("success","OK. Redirecting..."),void(window.location.href=t.xRedirect);t.activity("end","upload",e),t.emitOut("complete",e);var n=r.method.toLowerCase(),o=n[0].toUpperCase()+n.substring(1);t.emitOut("form"+o,e,t.getEntity())})}},loadEntity:function(t){var e=this;return this.activity("start"),v.getJson(t).fail(function(t){return e.errored_(t)}).done(function(t){e.activity("end","load",t),e.setEntity(t),e.emitOut("formGet",t)})},transformData:function(t){return t},validateData:function(t){},toJson:function(){return k.getJson(this)},notify:function(t,e){0===arguments.length&&(t=e=""),this.scope.notificationType=t,this.scope.notificationMsg=e,this.emitIn("formNotification",{type:t,message:e})},ensureCompo_:function(t){var e=jmask(this).children(t);0===e.length&&jmask(this).prepend(t)},ensureReflect_:function(){var t=jmask(this).children();0===t.length&&jmask(this).prepend("Reflect")},formLayout_:function(){var t=this,e="form";this.xFormType&&(e+="-"+this.xFormType,0===this.xOffset&&"horizontal"===this.xFormType&&(this.xOffset=1)),jmask(this).addClass(e).children().each(function(e){return null!=e.attr&&(e.attr.offset=t.xOffset)})},throw_:function(t){this.nodes=e.parse("\n			div style='background: red; color: white; padding: 15px; font-weight: bold' {\n				\""+t.message+'"\n			}\n		')},errored_:function(t){this.activity("end"),this.activity("error",t),this.notify("danger",t.message||String(t))}});e.define(E,"Reflect",{type:e.Dom.COMPONENT,renderStart:function(){function t(t,e){var n=jmask("@label").text(e.property);return jmask(t).attr(e).append(n)}var e=jmask(this),n=this.model;for(var r in n){var o=n[r];if(null!=o)switch(typeof o){case"string":case"number":e.append(t("Input",{type:typeof o,placeholder:r,property:r}));continue;case"boolean":e.append(t("Checkbox",{property:r,text:r}));continue}}}});var j="\n	// source Controls/ItemLayout.mask\n	let ItemLayout {\n		.form-group {\n			\n			label.control-label.col-sm-@[attr.offset] {\n				@label;\n			}\n			\n			.col-sm-@[12-attr.offset] {\n				@content;\n				@else > @element;\n			}\n		}\n	}\n	// end:source Controls/ItemLayout.mask\n	// source Controls/Notification.mask\n	let Notification as (div) {\n		\n		slot formNotification () {\n			var form = this.closest('a:form');\n			if (!form.scope.notificationMsg) {\n				return;\n			}\n			var el = this.$.get(0);\n			if (el) {\n				el.scrollIntoView(true);\n			}\n		}\n		\n		@if (template) {\n			@template;\n		}\n		@else {\n			+if (notificationMsg) {\n				.alert.alert-~[bind: $scope.notificationType] > '~[bind: $scope.notificationMsg ]'\n			}\n		}\n	}\n	// end:source Controls/Notification.mask\n	// source Controls/Progress.mask\n	let Progress {\n		var value = -1;\n		\n		slot formActivity (sender, type, name, percent) {\n			if (type === 'start') {\n				this.$.fadeIn();\n			}\n			if (type === 'end') {\n				this.$.fadeOut();\n			}\n			if (type !== 'progress') {\n				return;\n			}\n			this.scope.value = percent;\n		}\n		\n		.-a-form-progress {\n			\n			progress value='~[bind: $scope.value == -1 ? null : $scope.value]' max=100;\n			\n			style scoped {\n				:host {\n					background: rgba(0,0,0,.8);\n					position: absolute;\n					top: 0; left: 0; width: 100%; height: 100%;\n					z-index: 999;\n					display: none;\n				}\n				progress {\n					position: absolute;\n					top: 50%;\n					left: 1%;\n					width: 98%;\n				}\n			}\n		}\n	}\n	// end:source Controls/Progress.mask\n	// source Controls/Dialog.mask\n	let Dialog {\n		function show () {\n			this.$.modal('show');\n		}\n		function hide () {\n			this.$.modal('hide');\n		}\n		\n		slot hide () {\n			this.hide();\n		}\n		\n		.modal.fade\n			data-backdrop='@backdrop.attr.value'\n			data-keyboard='@keyboard.attr.value'\n			\n		> .modal-dialog > .modal-content {\n				.modal-header {\n					@if (backdrop.attr.value !== 'static') {\n						button.close data-dismiss= modal > span > 'x';\n					}\n					h4 .modal-title > @title;\n				}\n				@body > .modal-body style='position:relative; height:@attr.height' > @placeholder;\n				.modal-footer {\n					@footer;\n				}\n			}\n	}\n	// end:source Controls/Dialog.mask\n	\n	// source Editors/Array.mask\n	let Array {\n		\n		function getArray () {\n			var arr = mask.obj.get(this.model, this.attr.property);\n			if (arr == null) {\n				arr = [];\n				mask.obj.set(this.model, this.attr.property, arr);\n			}\n			return arr;\n		}\n		\n		slot arrayItemRemove (event) {\n			var model = $(event.target).model(),\n				arr = this.getArray(),\n				i = arr.indexOf(model);\n			arr.splice(i, 1);\n		}\n		\n		slot arrayItemAdd () {\n			var arr = this.getArray(),\n				item = {};\n			arr.push(item);\n		}\n		\n		\n		\n		include ItemLayout {\n			@element {\n				@header;\n				ul.list-unstyled > +each (@attr.property) {\n					li style='position:relative; padding: 0px 15px; box-sizing: border-box;' {\n						@template;\n					}\n				}\n				@footer;\n			}\n		}\n		\n		\n	}\n	\n	// end:source Editors/Array.mask\n	// source Editors/Checkbox.mask\n	let Checkbox {\n		include ItemLayout {\n			@element {\n				label {\n					input type='checkbox' class='@[attr.class]'>\n						:dualbind value='@attr.property';\n					\n					span > ' @[attr.text]'\n				}\n			}\n		}\n	}\n	// end:source Editors/Checkbox.mask\n	// source Editors/Input.mask\n	let Input {\n		include ItemLayout {\n			@element {\n				input\n					class = 'form-control @attr.class'\n					type='@[attr.type || \"text\"]'\n					placeholder='@attr.placeholder' >\n					\n						:dualbind value='@attr.property';\n			}\n		}\n	}\n	\n	// end:source Editors/Input.mask\n	// source Editors/Select.mask\n	let Select {\n		include ItemLayout {\n			@element {			\n				select .form-control {\n					@if (option) {\n						@each (option) > option value='@attr.value' {\n							@placeholder;\n						}\n					}\n					@if (template) {\n						@template;\n					}\n					dualbind value='@attr.property';\n				}\n			}\n		}\n	}\n	// end:source Editors/Select.mask\n	// source Editors/Radio.mask\n	let Radio {\n		include ItemLayout {\n			@element {\n				\n				@each (Option) > .radio > label {\n					input type = radio name='@attr.property' value='@attr.value' class='@attr.class' >\n						:dualbind value='@attr.property';\n						\n					@placeholder;\n				}\n				\n			}\n		}\n	}\n	// end:source Editors/Radio.mask\n	// source Editors/Text.mask\n	let Text {\n		include ItemLayout {\n			@element {\n				textarea .form-control placeholder='@attr.placeholder'  rows='@[attr.rows || 4]' >\n					:dualbind value='@attr.property';\n			}\n		}\n	}\n	// end:source Editors/Text.mask\n	// source Editors/Template.mask\n	let Template {\n		include ItemLayout {\n			@element > @template;\n		}\n	}\n	// end:source Editors/Template.mask\n	// source Editors/Hidden.mask\n	input type='hidden' name='@attr.property' >\n		dualbind value='@attr.property';\n	// end:source Editors/Hidden.mask\n	// source Editors/Image.mask\n	let Image {\n		\n		var meta = {\n			attributes: {\n				placeholder: 'http://placehold.it/200x100',\n				style: 'max-width:200px; max-height: 100px;'\n			}\n		};\n		\n		include ItemLayout {\n			@element {\n				ImagePicker placeholder='~[: $.xPlaceholder]' style='~[: $.xStyle]' {\n					dualbind\n						value='@attr.property'\n						dom-slot='imagePickerChanged'\n						getter='get'\n						setter='set';\n				}\n			}\n		}\n	}\n	\n	let ImagePicker {\n		\n		var meta = {\n			attributes: {\n				placeholder: '',\n				style: ''\n			},\n			template: 'join'\n		};\n		\n		var url  = '';\n		var blob = null;\n		\n		slot updateImage (event) {\n			var file = event.target.files[0];		\n			this.set(file);\n			this.emitOut('imagePickerChanged', file);\n			return false;\n		}\n		\n		function onRenderStart () {\n			this.scope.url = this.xPlaceholder;\n		}\n		\n		function get () {\n			if (this.scope.blob) {\n				return this.scope.blob;\n			}\n			if (this.scope.url && this.scope.url !== this.xPlaceholder) {\n				return this.scope.url;\n			}\n			return null;\n		}\n		function set (val) {\n			if (val == null) {\n				this.scope.blob = null;\n				this.scope.url = this.xPlaceholder;\n				return;\n			}\n			if (typeof val === 'string') {\n				this.scope.blob = null;\n				this.scope.url = val;\n				return;\n			}\n			\n			this.scope.url  = URL.createObjectURL(val);\n			this.scope.blob = val;\n		}\n		\n		table {\n			tr > td > img src='~[bind: $scope.url]' style='~[: $.xStyle ]';\n			tr > td {\n				input type='file' x-signal='change: updateImage';\n			}\n		}\n	}\n	// end:source Editors/Image.mask\n";e.define(E,j),e.registerHandler("a:form",E)});
//# sourceMappingURL=form.min.js.map